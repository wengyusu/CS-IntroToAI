<!doctype html><html><head><meta charset="utf-8">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js">
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
<link rel="stylesheet" href="https://gitcdn.xyz/repo/goessner/mdmath/master/css/texmath.css">
<link rel="stylesheet" href="https://gitcdn.xyz/repo/goessner/mdmath/master/css/vscode-texmath.css">

</head><body>
<h1 id="assignment4-2" data-line="0" class="code-line">Assignment4</h1>
<p data-line="1" class="code-line">Yusu Weng(yw706) Zhaoxiang Liu(zl355)</p>
<h2 id="cnn-regression-approach-2" data-line="3" class="code-line">CNN-Regression Approach</h2>
<h3 id="model-structure-4" data-line="4" class="code-line">Model Structure</h3>
<p data-line="5" class="code-line">Input Layer</p>
<p data-line="7" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇓</mo></mrow><annotation encoding="application/x-tex">\Downarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">⇓</span></span></span></span></eq></p>
<p data-line="9" class="code-line">Convolutional Layer</p>
<p data-line="11" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇓</mo></mrow><annotation encoding="application/x-tex">\Downarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">⇓</span></span></span></span></eq></p>
<p data-line="13" class="code-line">Convolutional Layer</p>
<p data-line="15" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇓</mo></mrow><annotation encoding="application/x-tex">\Downarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">⇓</span></span></span></span></eq></p>
<p data-line="17" class="code-line">MaxPooling Layer</p>
<p data-line="19" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇓</mo></mrow><annotation encoding="application/x-tex">\Downarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">⇓</span></span></span></span></eq></p>
<p data-line="21" class="code-line">Flatten Layer</p>
<p data-line="23" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇓</mo></mrow><annotation encoding="application/x-tex">\Downarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">⇓</span></span></span></span></eq></p>
<p data-line="25" class="code-line">Dropout Layer</p>
<p data-line="27" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇓</mo></mrow><annotation encoding="application/x-tex">\Downarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">⇓</span></span></span></span></eq></p>
<p data-line="29" class="code-line">FullConnected Layer</p>
<p data-line="31" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇓</mo></mrow><annotation encoding="application/x-tex">\Downarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">⇓</span></span></span></span></eq></p>
<p data-line="33" class="code-line">FullConnected Layer</p>
<p data-line="35" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇓</mo></mrow><annotation encoding="application/x-tex">\Downarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mrel">⇓</span></span></span></span></eq></p>
<p data-line="37" class="code-line">Output Layer</p>
<h3 id="representing-the-process-4" data-line="38" class="code-line">Representing the process</h3>
<p data-line="39" class="code-line">To better solve the problem, we first convert RGB color space to CIELAB(LAB) color space. The LAB space consists of three channels: L for lightness, A for green-red, B for blue-yellow. The value of L ranges from 0 to 100, while other two channel range from -128 to 127. Since the grayscale image only has L channel, we can represent the process as mapping the L channel as input to the A&amp;B channels as the output. At last, we convert the predicted LAB space back to the RGB space.</p>
<h3 id="data-4" data-line="41" class="code-line">Data</h3>
<p data-line="43" class="code-line">We obtain the data from Imagenet, with the category of seashore.</p>
<pre><code data-line="44" class="code-line"><code><div>http://image-net.org/api/text/imagenet.synset.geturls?wnid=n09428293
</div></code></code></pre>
<p data-line="47" class="code-line">Due to the limitation of the computing power of our laptops, we only downloaded 1000 images as the train set, and 100 addtional images as the validation set.</p>
<p data-line="49" class="code-line">These images are not included in the archive but can be downloaded by the python script <code>get_dataset.py</code></p>
<h3 id="preprocess-4" data-line="51" class="code-line">Preprocess</h3>
<p data-line="52" class="code-line">Before training, we resize the images to 64pixelsx64pixels and read as a 2D array.</p>
<p data-line="54" class="code-line">We also preprocess the input values of LAB channels, converting them range from 0 to 1.</p>
<h3 id="evaluation-4" data-line="55" class="code-line">Evaluation</h3>
<p data-line="57" class="code-line">We choose Mean-squared Error(MSE) as the loss function:</p>
<p data-line="59" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msqrt><mrow><mo stretchy="false">(</mo><mover accent="true"><msub><mi>A</mi><mi>i</mi></msub><mo>~</mo></mover><mo>−</mo><msub><mi>A</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mover accent="true"><msub><mi>B</mi><mi>i</mi></msub><mo>~</mo></mover><mo>−</mo><msub><mi>B</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">Loss=\frac{1}{n}\sum^{n}_{i=1}{\sqrt{(\tilde{A_i}-A_i)^2+(\tilde{B_i}-B_i)^2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">L</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.84em;vertical-align:-0.5199050000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.804292em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.320095em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"></span><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9201899999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.6023300000000003em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">~</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9201899999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.6023300000000003em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">~</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.2800949999999998em;"><span class="pstrut" style="height:3.8em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.8800000000000001em;"><svg width='400em' height='1.8800000000000001em' viewBox='0 0 400000 1944' preserveAspectRatio='xMinYMin slice'><path d='M1001,80H400000v40H1013.1s-83.4,268,-264.1,840c-180.7,
572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,
-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744c-10,12,-21,25,-33,39s-32,39,-32,39
c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30c26.7,-32.7,52,-63,76,-91s52,-60,52,-60
s208,722,208,722c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,
-658.5c53.7,-170.3,84.5,-266.8,92.5,-289.5c4,-6.7,10,-10,18,-10z
M1001 80H400000v40H1013z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5199050000000001em;"><span></span></span></span></span></span></span></span></span></span></eq></p>
<p data-line="61" class="code-line">n is the total number of pixels</p>
<p data-line="63" class="code-line">We also define that if <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">∣</mi><mover accent="true"><msub><mi>A</mi><mi>i</mi></msub><mo>~</mo></mover><mo>−</mo><msub><mi>A</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mo>≤</mo><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">|\tilde{A_i}-A_i|\leq=10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1701899999999998em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9201899999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.6023300000000003em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">~</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span></span></span></span></eq> and <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">∣</mi><mover accent="true"><msub><mi>B</mi><mi>i</mi></msub><mo>~</mo></mover><mo>−</mo><msub><mi>B</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mo>≤</mo><mo>=</mo><mn>10</mn><mo separator="true">,</mo><mi>p</mi><mi>i</mi><mi>x</mi><mi>e</mi><msub><mi>l</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">|\tilde{B_i}-B_i|\leq=10,pixel_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1701899999999998em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9201899999999998em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.6023300000000003em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;">~</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span></span><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">i</span><span class="mord mathdefault">x</span><span class="mord mathdefault">e</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></eq> is correct since human can hardly tell the difference.</p>
<p data-line="65" class="code-line">So the <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mi>c</mi><mi>c</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>y</mi><mo>=</mo><mfrac><mrow><mi mathvariant="normal">#</mi><mo stretchy="false">{</mo><mi>c</mi><mi>o</mi><mi>r</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>p</mi><mi>i</mi><mi>x</mi><mi>e</mi><mi>l</mi><mi>s</mi><mo stretchy="false">}</mo></mrow><mrow><mi mathvariant="normal">#</mi><mo stretchy="false">{</mo><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi><mi>p</mi><mi>i</mi><mi>x</mi><mi>e</mi><mi>l</mi><mi>s</mi><mo stretchy="false">}</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">accuracy=\frac{\#\{correct pixels\}}{\#\{total pixels\}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault">c</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">#</span><span class="mopen mtight">{</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">s</span><span class="mclose mtight">}</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">#</span><span class="mopen mtight">{</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">s</span><span class="mclose mtight">}</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></eq></p>
<h3 id="training-4" data-line="67" class="code-line">Training</h3>
<p data-line="69" class="code-line">Instead of Gradient descent, we choose Stochatic gradient descent for two reasons. First, it is computationally cheaper to compute the gradients with respect to one of these loss terms
rather than every loss term in the full sum of dataset. Second, SGD is less likely to be trapped in local minima as it is less sensitive to fine grained details in dataset. Practically, we set the batch size as 10 instead of the total number of the dataset.</p>
<p data-line="73" class="code-line">We also introduce some methods to prevent overfitting:</p>
<p data-line="75" class="code-line"><code>Regularization</code></p>
<p data-line="77" class="code-line">We add a L2 Regularizer to the loss function:</p>
<p data-line="79" class="code-line"><eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo>=</mo><mi>L</mi><mi>o</mi><mi>s</mi><mi>s</mi><mo>+</mo><mi>λ</mi><mo>∑</mo><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>w</mi><mi mathvariant="normal">∣</mi><msup><mi mathvariant="normal">∣</mi><mn>2</mn></msup></mrow></mrow><annotation encoding="application/x-tex">Cost=Loss+\lambda\sum{||w||^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">L</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064118em;vertical-align:-0.25001em;"></span><span class="mord mathdefault">λ</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord">∣</span><span class="mord">∣</span><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></eq></p>
<p data-line="81" class="code-line">In practice we set the <eq><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>λ</mi></mrow><annotation encoding="application/x-tex">\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">λ</span></span></span></span></eq> 0.001</p>
<p data-line="83" class="code-line"><code>Early Termination</code></p>
<p data-line="85" class="code-line">As mentioned before we have a validation set to track the performation. We can terminate the training when the error on the validation set beigin to increase.</p>
<p data-line="87" class="code-line"><code>Dropout Layer</code></p>
<p data-line="89" class="code-line">The dropout layer can ignore certain sets of neurons during the training which is chosen at random.Dropout forces a neural network to learn more robust features that are useful in conjunction with many different random subsets of the other neurons.We set the dropout rate as 0.2</p>
<h3 id="assessment-2" data-line="91" class="code-line">Assessment</h3>
<p data-line="92" class="code-line">Our model can reach a 68% accuracy on coloring images with category of seashore.</p>
<p data-line="94" class="code-line"><code>Demos</code></p>
<p data-line="96" class="code-line"><code>Example1</code></p>
<p data-line="98" class="code-line">Real
<img src="/Users/wengyusu/AI/Assignment4/demo/1.png" alt="Real" class="loading" id="image-hash-33c2d33104e0352b97ce8f567c8470fdfe36da1c650c2ef1ae98fada4f420a84"></p>
<p data-line="101" class="code-line">Prediction</p>
<p data-line="103" class="code-line"><img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/2.png" alt="Prediction" class="loading" id="image-hash-e40649b4394713f8d77aac634239d24ea7b814e32b9d7e32ee1a179129cf4e23"></p>
<p data-line="105" class="code-line"><code>Example2</code></p>
<p data-line="107" class="code-line">Real
<img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/3.png" alt="Real" class="loading" id="image-hash-af5b1bd9980fd996df7e62e56ec43491a2b3c217d65d69f1e41a1110d96e142d"></p>
<p data-line="110" class="code-line">Prediction</p>
<p data-line="112" class="code-line"><img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/4.png" alt="Prediction" class="loading" id="image-hash-f829333050a350964fecd07fbd14998dcb0396713083079aaa9b1e4d9ad496e0"></p>
<p data-line="114" class="code-line"><code>Example3</code></p>
<p data-line="116" class="code-line">Real
<img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/5.png" alt="Real" class="loading" id="image-hash-d442e2b6b854791c37773104a3355757098b2d61267989d9d20c857710f57aa9"></p>
<p data-line="119" class="code-line">Prediction</p>
<p data-line="121" class="code-line"><img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/6.png" alt="Prediction" class="loading" id="image-hash-bcb65fe8bb8155ad6182df5ad522aec5ac60b8a6f843ee3012a98e2523afbcb6"></p>
<p data-line="123" class="code-line"><code>Example4</code></p>
<p data-line="125" class="code-line">Real
<img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/7.png" alt="Real" class="loading" id="image-hash-29d5996856cb0025a8013b38b20df0d0100f075d6079c1e1cce001d95eb36204"></p>
<p data-line="128" class="code-line">Prediction</p>
<p data-line="130" class="code-line"><img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/8.png" alt="Prediction" class="loading" id="image-hash-3617a3763c75122ef583d603cf711dbbb66171666afc4631c124274657dff6e7"></p>
<p data-line="132" class="code-line">Base on our observation, predicted images make sense in some degree, but still have some evident flaws:</p>
<p data-line="134" class="code-line">First, the overall prediction of our model is conservative. The predicted color is always less vivid than the real color.</p>
<p data-line="136" class="code-line">Second, the margin between sea, sky and beach is vague and the model tend to use close colors to colorize them.</p>
<p data-line="138" class="code-line">Finally, the model may confuse the sea with beach if the coastline is irregular.</p>
<p data-line="140" class="code-line">Besides, the model cannot handle the images that are not seashore at all as was expected. The model will try to use blue and yellow which are colors of sea and sands to colorize the image.
<img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/9.png" alt="" class="loading" id="image-hash-4cae51d469d3f807099a28634547269beed3a3505adfcd7102dfb654002c7c53">
<img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/10.png" alt="" class="loading" id="image-hash-453ba65f2fa647f9384591690cf5c4e065d92e8bc6521a3f8500e899354c4031"></p>
<h3 id="rethinking--improvement-2" data-line="143" class="code-line">Rethinking &amp; Improvement</h3>
<p data-line="145" class="code-line">First, the size of dataset maybe not enough for the problem as our model seems not to extract all the features from the image correctly, which leads some mistakes when finding the margin between land and sea.</p>
<p data-line="147" class="code-line">Then, the loss function we choose encourages the model to make a conservative selection on colors. These losses are inherited from standard regression
problems, where the goal is to minimize Mean squared error between an estimate
and the ground truth.
Additionally, the model will prefer to use a set of similar color uniformly rather than choose a set of colors that are distinct to each other.</p>
<p data-line="152" class="code-line">To improve it, maybe we should try to consider it as a classification problem rather than a regression problem to avoid the model to choose an mean of the set. Instead, we can use cross entropy loss to have a better performance</p>
<h2 id="simple-neuralnetwork-classificaton-approach-2" data-line="154" class="code-line">Simple NeuralNetwork-Classificaton Approach</h2>
<h3 id="model-structure-5" data-line="156" class="code-line">Model Structure</h3>
<p data-line="158" class="code-line">9 neurons =&gt; 9 neurons=&gt;4 neurons(one-hot code)</p>
<h3 id="representing-the-process-5" data-line="160" class="code-line">Representing the process</h3>
<p data-line="162" class="code-line">We apply a simple neural network as our classification method. For each input image with RGB color space, We know that each value ranges from 0 to 255. It's difficult for us to apply the classification method because we may need to set up a 255 one-hot code output layer, the calculation cost is too high so we firstly normalize our RGB values only have 4 options[0,80,160,240]. So our hot-code only needs to be set up with 4 neurons with a combination of 1 and 0 to represent each RGB value separately. For each gray pixel value, we will predict the R, G, B value separately and combine them finally as an output image. We will explain our network detail below
For a simple neural network, we have a [9,9,4] layer structure. 9 neurons as input layer and 4 neurons as output layer. Our neural network model simply aims to map a single gray color value to an R, G, B color value separately. Firstly we will input an image and set a  sliding window. Second, we will extract each pixel from the entire picture from the top left corner to the bottom right corner. Each step we will choose the selected pixel and its surrounding 8 pixels as input, so we have enough information to avoid bias and reconstruct the correct color. The training output is a one-hot code which represents R or G or B value
We will build 3 neural networks for training R, G and B color value simultaneously. and reconstruct the image using RGB color space</p>
<h3 id="data-5" data-line="166" class="code-line">Data</h3>
<p data-line="168" class="code-line">We use the same dataset but because our neural network is simple and train for each pixel. We use similar photos of the scene to make the dataset in order to get a high recover result</p>
<h3 id="preprocess-5" data-line="170" class="code-line">Preprocess</h3>
<p data-line="172" class="code-line">For simple neural network we don't do too much pre-processing job. Just train 3 models for each pixels input and predict the R,G and B value.</p>
<p data-line="174" class="code-line">Once we get the predicted value from 2 method we wil reconstruct the image using RGB color space and Matlab built-in library</p>
<h3 id="evaluation-5" data-line="176" class="code-line">Evaluation</h3>
<p data-line="178" class="code-line">Because we have already normalized the RGB color space to one of the value of [0,80,160,240]</p>
<p data-line="180" class="code-line">So for the input and output RGB image nparray we firstly divide by 80 and use Euclidean distance to measure the difference:</p>
<p data-line="182" class="code-line"><img src="https://wikimedia.org/api/rest_v1/media/math/render/svg/795b967db2917cdde7c2da2d1ee327eb673276c0" alt="avatar" class="loading" id="image-hash-d42ed7b00c7655345faca5a0123d5081da386ff6de2b8fa120a45d45f5dbb3f9"></p>
<p data-line="184" class="code-line">Second because each picture we predicted has a different scale so we will calculate the mean of Euclidean distance for each image and result will be comparable and generic</p>
<p data-line="186" class="code-line">Error=Total Euclidean distance /numbers of pixels</p>
<p data-line="188" class="code-line">We prove our error metric is correct and consistent with our percetual error in assessment part</p>
<h3 id="training-5" data-line="190" class="code-line">Training</h3>
<p data-line="192" class="code-line">For deatail training process we mentioned in the 1st part</p>
<p data-line="194" class="code-line">We use tanh as our activation function because it's more advanced in simple neural network structure and also use the number of epochs and learning rate to control the training process and to find a convergence. For our model we set epochs=20000 and learning rate=0.05 with gradient descent. I think it is enough to reach a high complete neural network</p>
<h3 id="assessment-and-improvement-2" data-line="196" class="code-line">Assessment and improvement</h3>
<p data-line="198" class="code-line">We use Mean Euclidean distance as our Error to measure the result.</p>
<p data-line="200" class="code-line">For sky error: 0.00043409591371904786</p>
<p data-line="202" class="code-line">For forest error: 0.0009118240178506841</p>
<p data-line="204" class="code-line">For scenery error:0.0019461416507325722</p>
<p data-line="206" class="code-line"><img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/sky.png" alt="Prediction" class="loading" id="image-hash-c8fe47c2ef34c46c639eb62632115dec7538e2aebb1df623d94102a7bae54b1c"></p>
<p data-line="210" class="code-line">Error: 0.00043409591371904786</p>
<p data-line="212" class="code-line">From the pictures, we can observe that the model can distinguish sky and cloud. Because our training data is simple so the recover result perform well</p>
<p data-line="214" class="code-line"><img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/forest.png" alt="Prediction" class="loading" id="image-hash-11a26a6cb09006150f5c88fd33299a45ad191b2308b4c93b66303e9b9d059667"></p>
<p data-line="216" class="code-line">Error: 0.0009118240178506841</p>
<p data-line="218" class="code-line">The above test shows that a slight distortion appears for the recovered image, We can still recognize the feature of a forest but with wrong color space. Because environmental complexity has increased. The Mean Euclidean distance is also bigger than the previous one, which also proves that numerical/quantified error and perceptual error perform consistently</p>
<p data-line="220" class="code-line"><img src="vscode-resource:/Users/wengyusu/AI/Assignment4/demo/rgb.png" alt="Prediction" class="loading" id="image-hash-7651c221f827b57db31150f80d36e2f382f285bcc655f885e701729b5d78aa44"></p>
<p data-line="222" class="code-line">Error: 0.0019461416507325722</p>
<p data-line="224" class="code-line">From the above experiment we can conclude even if our training data and test data have the same structure but different color space we still cannot avoid coloring wrong. We train our model to fit the B color space even if our input picture has the same structure will still get a blue-like picture with big distortion</p>
<p data-line="226" class="code-line">Our program is good at the same color space coloring and the picture with small complexity</p>
<p data-line="228" class="code-line">I think the result still can be improved. If we increase the sorts of colors used in classification, we maybe able to improve the result and avoid the distortion, (A longer one-hot code can not only increase the color space but also improve fault tolerance for different color space picture).
Also, we can enlarge our dataset to get a better result.</p>

</body></html>